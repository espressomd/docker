ARG BASE_VERSION=3.8
FROM rocm/dev-ubuntu-18.04:${BASE_VERSION}
ENV DEBIAN_FRONTEND noninteractive
COPY ubuntu-packages.txt /tmp
ARG BASE_VERSION
RUN apt_folder=$([ "${BASE_VERSION}" = "latest" ] && echo "debian" || echo "${BASE_VERSION}") \
    && sed -i "s|repo.radeon.com/rocm/apt/debian/|repo.radeon.com/rocm/apt/${apt_folder}/|" /etc/apt/sources.list.d/rocm.list \
    && apt-get update && xargs -a /tmp/ubuntu-packages.txt apt-get install --no-install-recommends -y \
    && apt-get install --no-install-recommends -y \
    rocrand rocfft rocthrust rocblas rocsolver kmod \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

RUN useradd -m espresso
USER espresso
ENV HOME="/home/espresso"
ENV PATH="${HOME}/.local/bin:${PATH}"
RUN pip3 install --user 'cmake==3.11'
WORKDIR /home/espresso
