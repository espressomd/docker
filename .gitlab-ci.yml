stages:
  - build
  - test
  - deploy
  - status

.manual_template:
  when: manual

.build_template:
  stage: build
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  before_script:
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"username\":\"$CI_REGISTRY_USER\",\"password\":\"$CI_REGISTRY_PASSWORD\"}}}" > /kaniko/.docker/config.json
  script:
    - sh maintainer/docker_build.sh
  tags:
    - docker
    - linux
    - nofirewall

.deploy_template:
  extends: .build_template
  stage: deploy
  only:
    - master
    - /[0-9]\..*/

.test_template:
  stage: test
  image: $CI_REGISTRY/$CI_PROJECT_PATH/$CI_JOB_NAME-$CI_COMMIT_SHA
  script:
    - git clone -b 4.0 --depth=1 --recursive https://github.com/espressomd/espresso
    - cd espresso
    - maintainer/CI/build_cmake.sh
  variables:
    make_check: "false"
    myconfig: "maxset"
  tags:
    - docker
    - linux

centos:7:build:
  extends: .build_template
centos:next:build:
  extends: .build_template
debian:9:build:
  extends: .build_template
opensuse:42.3:build:
  extends: .build_template
opensuse:15.0:build:
  extends: .build_template
ubuntu:18.04:build:
  extends: .build_template
ubuntu:wo-dependencies:build:
  extends: .build_template
clang:6.0:build:
  extends: .build_template
intel:15:build:
  extends:
    - .build_template
    - .manual_template
  tags:
    - docker
    - linux
    - nofirewall
    - icp

test/centos:7:
  extends: .test_template
test/centos:next:
  extends: .test_template
test/debian:9:
  extends: .test_template
test/opensuse:42.3:
  extends: .test_template
test/opensuse:15.0:
  extends: .test_template
test/ubuntu:18.04:
  extends: .test_template
test/clang:6.0:
  extends: .test_template
test/intel:15:
  extends:
    - .test_template
    - .manual_template
  tags:
    - docker
    - linux
    - icp
test/ubuntu:wo-dependencies:
  extends: .test_template


centos:7:
  extends: .deploy_template
centos:next:
  extends: .deploy_template
debian:9:
  extends: .deploy_template
opensuse:42.3:
  extends: .deploy_template
opensuse:15.0:
  extends: .deploy_template
ubuntu:18.04:
  extends: .deploy_template
ubuntu:wo-dependencies:
  extends: .deploy_template
clang:6.0:
  extends: .deploy_template
intel:15:
  extends:
    - .deploy_template
    - .manual_template
  tags:
    - docker
    - linux
    - nofirewall
    - icp

status_success:
  stage: status
  image: $CI_REGISTRY/espressomd/docker/ubuntu:18.04
  script: bash maintainer/gh_post_status.sh success
  when: on_success
  tags:
    - linux

status_failure:
  stage: status
  image: $CI_REGISTRY/espressomd/docker/ubuntu:18.04
  script: bash maintainer/gh_post_status.sh failure
  when: on_failure
  tags:
    - linux
